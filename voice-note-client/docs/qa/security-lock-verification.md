# 安全设置与手势/密码解锁 — 功能验证说明

本文档覆盖「安全设置」模块的开启/关闭、解锁触发、双解锁方式切换与状态持久化的全流程验证步骤。

## 一、开启流程

### 1.1 手势解锁开启

1. 进入 **设置** → 在「安全设置」分区找到「手势解锁」。
2. 确认副标题为「设置手势图案，保护你的账单隐私」，开关为关。
3. 点击开关（意图开启）：**不立刻变开**，应跳转到「设置手势」页。
4. 在 3×3 网格中绘制手势（至少连接 4 个点）：
   - 第一次绘制完成后，提示变为「请再次绘制确认」。
   - 再次绘制与第一次**一致** → 提示「设置成功」，自动返回设置页，「手势解锁」开关变为**开启**，副标题为「已开启手势解锁」。
   - 若两次**不一致** → 提示「两次绘制的手势不一致，请重新设置」，可点「重置」后重新绘制。
5. 点击「重置」可清空当前步骤，重新从第一次绘制开始。

### 1.2 密码解锁开启

1. 在「安全设置」分区找到「密码解锁」。
2. 确认副标题为「设置数字密码，保护你的账单隐私」，开关为关。
3. 点击开关（意图开启）：跳转到「设置密码」页。
4. 输入 6 位数字：
   - 第一次输入完成后，提示变为「请再次输入确认」。
   - 第二次输入与第一次**一致** → 自动返回设置页，「密码解锁」开关变为**开启**，副标题为「已开启密码解锁」。
   - 若两次**不一致** → 提示「两次输入的密码不一致，请重新设置」，可点「重置」后重新输入。
5. 「重置」可清空当前输入，重新设置。

## 二、关闭流程

### 2.1 关闭前验证

1. 在「手势解锁」或「密码解锁」为**开启**状态下，点击对应开关（意图关闭）。
2. **不立刻变关**，应跳转到「验证以关闭」页（或验证弹窗）。
3. 使用**当前已开启的任意一种**解锁方式验证（仅开手势则用手势，仅开密码则用密码，两种都开则可用任一种）：
   - **验证成功** → 返回设置页，对应开关变为**关闭**。
   - **验证失败** → 提示「解锁失败，请重试」，开关保持**开启**。

## 三、App 解锁触发

### 3.1 冷启动

1. 确保至少开启「手势解锁」或「密码解锁」其一。
2. 完全退出 App（杀进程）。
3. 重新打开 App：
   - 应**先出现解锁页**，无法直接进入首页。
   - 解锁成功后进入首页（或之前要去的页面）。

### 3.2 从后台切回前台

1. 确保已开启任一解锁方式，且当前已解锁进入 App。
2. 按 Home 键或切换到其他 App。
3. 再切回本 App：
   - 应**再次出现解锁页**。
   - 解锁成功后回到当前页面。

### 3.3 解锁页行为

- **仅开启手势**：只显示手势解锁区域。
- **仅开启密码**：只显示密码解锁区域。
- **两种都开启**：默认显示手势解锁，底部有「切换到密码解锁」；可切换为密码解锁。**任一种验证通过**即可进入。
- 解锁失败：提示「解锁失败，请重试」；连续失败 5 次可提示「请稍后再试」（若已实现）。
- 无返回键，只能通过验证进入 App。

## 四、双解锁方式切换（解锁页内）

1. 同时开启「手势解锁」和「密码解锁」。
2. 触发解锁页（冷启动或从后台切回）。
3. 默认应为**手势解锁**界面。
4. 点击「切换到密码解锁」→ 变为密码输入界面。
5. 点击「切换到手势解锁」→ 变回手势界面。
6. 用手势或密码任一种验证通过，均应成功进入 App。

## 五、状态持久化

1. **开关状态**（SharedPreferences）：
   - 开启/关闭手势或密码后，完全退出 App 并重新打开，对应开关状态应保持。
   - 进入设置页时，副标题与开关状态应与上次一致。

2. **敏感数据**（flutter_secure_storage）：
   - 设置的手势/密码以哈希形式存储，不存明文。
   - 重启、重新进入设置、后台切回后，验证逻辑均使用持久化数据，不出现「状态重置」或「逻辑失效」。

3. **会话解锁标志**（内存）：
   - 冷启动后未解锁前，应显示解锁页。
   - 解锁后在同一会话内不再次要求解锁（除非切到后台再回来，此时应再次要求解锁）。

## 六、回归检查（设置页其他功能）

验证过程中确认以下**未被改动**：

- 「外观」「数据管理」「语音输入」「偏好设置」各分区及其中所有项（主题、主题色、多账户、分类管理、预算、数据导出、默认输入模式、语音播报、服务器地址、隐藏自动语音模式）的业务逻辑、UI 样式与交互均与原有一致。
